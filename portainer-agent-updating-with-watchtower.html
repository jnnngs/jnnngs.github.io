<!DOCTYPE html><html lang="en-gb"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Portainer agent updating with watchtower - jnnngs</title><meta name="description" content="I use watchtower to update my containers but the Portainer agent keeps to have issues when updated. Whenever watchtower updates the container, it keeps restarting with the following error message: agent_1 | 2021/08/05 12:22:25 [ERROR] [main,docker] [message: Unable to retrieve local agent IP address] [error:&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://jnnn.gs/portainer-agent-updating-with-watchtower.html"><link rel="alternate" type="application/atom+xml" href="https://jnnn.gs/feed.xml"><link rel="alternate" type="application/json" href="https://jnnn.gs/feed.json"><meta property="og:title" content="Portainer agent updating with watchtower"><meta property="og:site_name" content="jnnngs"><meta property="og:description" content="I use watchtower to update my containers but the Portainer agent keeps to have issues when updated. Whenever watchtower updates the container, it keeps restarting with the following error message: agent_1 | 2021/08/05 12:22:25 [ERROR] [main,docker] [message: Unable to retrieve local agent IP address] [error:&hellip;"><meta property="og:url" content="https://jnnn.gs/portainer-agent-updating-with-watchtower.html"><meta property="og:type" content="article"><style>:root{--body-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--heading-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--logo-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--menu-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"}</style><link rel="stylesheet" href="https://jnnn.gs/assets/css/style.css?v=2405d04b119f74cf51b884beb85eb424"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://jnnn.gs/portainer-agent-updating-with-watchtower.html"},"headline":"Portainer agent updating with watchtower","datePublished":"2021-10-28T10:41","dateModified":"2021-10-28T10:41","description":"I use watchtower to update my containers but the Portainer agent keeps to have issues when updated. Whenever watchtower updates the container, it keeps restarting with the following error message: agent_1 | 2021/08/05 12:22:25 [ERROR] [main,docker] [message: Unable to retrieve local agent IP address] [error:&hellip;","author":{"@type":"Person","name":"Jnnngs"},"publisher":{"@type":"Organization","name":"Jnnngs"}}</script></head><body><div class="site-container"><header class="top" id="js-header"><a class="logo" href="https://jnnn.gs/">jnnngs</a></header><main><article class="post"><div class="hero"><header class="hero__content"><div class="wrapper"><div class="post__meta"><time datetime="2021-10-28T10:41">October 28, 2021</time></div><h1>Portainer agent updating with watchtower</h1></div></header></div><div class="wrapper post__entry"><p>I use watchtower to update my containers but the Portainer agent keeps to have issues when updated. Whenever watchtower updates the container, it keeps restarting with the following error message:</p><p><code>agent_1 | 2021/08/05 12:22:25 [ERROR] [main,docker] [message: Unable to retrieve local agent IP address] [error: Error: No such container: 6c9fd4504fb5]</code></p><p>I use the following docker command to add the agent:</p><div class="snippet-clipboard-content position-relative overflow-auto"><pre><code>docker run -d \<br>    -v /var/run/docker.sock:/var/run/docker.sock \<br>    -v /var/lib/docker/volumes:/var/lib/docker/volumes \<br>    -v /:/host \<br>    -v portainer_agent_data:/data \<br>    --restart always \<br>    -e EDGE=1 \<br>    -e EDGE_ID=XXXXXXXXXXXXXXXXXXXXXXXXXXX \<br>    -e EDGE_KEY=XXXXXXXXXXXXXXXXXXXXXXXXXXX \<br>    -e CAP_HOST_MANAGEMENT=1 \<br>    -e EDGE_INSECURE_POLL=1 \<br>    portainer/agent:latest
</code></pre></div><p> The problem is with watchtower, as it clones the container configs included hostname when upgrading the container.</p><p>When upgrade/re-creating the container, by default the docker daemon will assign a new hostname to the container and update internal dns, but the watchtower won't update the container hostname after the container upgrade so the agent will try to look up the old hostname and it would be getting nxdomain result by docker internal dns.</p><p>The fix is to assign a container name and a container hostname so that they stay the same and not causing watchtower issues.</p><div class="snippet-clipboard-content position-relative overflow-auto"><pre><code>docker run -d \<br>    -v /var/run/docker.sock:/var/run/docker.sock \<br>    -v /var/lib/docker/volumes:/var/lib/docker/volumes \<br>    -v /:/host \<br>    -v portainer_agent_data:/data \<br>    --restart always \<br>    -e EDGE=1 \<br>    -e EDGE_ID=XXXXXXXXXXXXXXXXXXXXXXXXXXX \<br>    -e EDGE_KEY=XXXXXXXXXXXXXXXXXXXXXXXXXXX \<br>    -e CAP_HOST_MANAGEMENT=1 \<br>    -e EDGE_INSECURE_POLL=1 \<br><strong>    --name portainer_edge_agent \</strong><br><strong>    --hostname portainer_edge_agent \</strong><br>    portainer/agent:latest    portainer/agent:latest</code></pre></div></div><footer class="wrapper post__footer"><p class="post__last-updated">This article was updated on October 28, 2021</p><ul class="post__tag"><li><a href="https://jnnn.gs/tags/devops/">DevOps</a></li></ul><div class="post__share"><a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fjnnn.gs%2Fportainer-agent-updating-with-watchtower.html" class="js-share facebook" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://jnnn.gs/assets/svg/svg-map.svg#facebook"/></svg> <span>Facebook</span> </a><a href="https://twitter.com/share?url=https%3A%2F%2Fjnnn.gs%2Fportainer-agent-updating-with-watchtower.html&amp;via=%40jnnngs&amp;text=Portainer%20agent%20updating%20with%20watchtower" class="js-share twitter" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://jnnn.gs/assets/svg/svg-map.svg#twitter"/></svg> <span>Twitter</span> </a><a href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fjnnn.gs%2Fportainer-agent-updating-with-watchtower.html&amp;title=Portainer%20agent%20updating%20with%20watchtower" class="js-share linkedin" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://jnnn.gs/assets/svg/svg-map.svg#linkedin"/></svg> <span>LinkedIn</span> </a><a href="https://api.whatsapp.com/send?text=Portainer%20agent%20updating%20with%20watchtower https%3A%2F%2Fjnnn.gs%2Fportainer-agent-updating-with-watchtower.html" class="js-share whatsapp" rel="nofollow noopener noreferrer"><svg class="icon" aria-hidden="true" focusable="false"><use xlink:href="https://jnnn.gs/assets/svg/svg-map.svg#whatsapp"/></svg> <span>WhatsApp</span></a></div><div class="post__bio bio"><div class="bio__info"><h3 class="bio__name"><a href="https://jnnn.gs/authors/paul-jennings/" class="invert" rel="author">Jnnngs</a></h3></div></div></footer></article><nav class="post__nav"><div class="post__nav-inner"><div class="post__nav-prev"><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://jnnn.gs/assets/svg/svg-map.svg#arrow-prev"/></svg> <a href="https://jnnn.gs/clearing-systemd-journal-logs.html" class="invert post__nav-link" rel="prev"><span>Previous</span> Clearing systemd journal logs</a></div><div class="post__nav-next"><a href="https://jnnn.gs/upgrading-teleport-nodes.html" class="invert post__nav-link" rel="next"><span>Next</span> Upgrading Teleport nodes </a><svg width="1.041em" height="0.416em" aria-hidden="true"><use xlink:href="https://jnnn.gs/assets/svg/svg-map.svg#arrow-next"/></svg></div></div></nav><div class="post__related related"><div class="wrapper"><h2 class="h5 related__title">You should also read:</h2><article class="related__item"><div class="feed__meta"><time datetime="2021-12-21T12:08" class="feed__date">December 21, 2021</time></div><h3 class="h1"><a href="https://jnnn.gs/architecture-for-aws-vpc-internet-facing-public-subnet-with-private-subnet-backend.html" class="invert">Architecture for AWS VPC: Internet-facing Public subnet with Private subnet backend</a></h3></article><article class="related__item"><div class="feed__meta"><time datetime="2021-01-08T17:07" class="feed__date">January 8, 2021</time></div><h3 class="h1"><a href="https://jnnn.gs/how-to-configure-multiple-domains-with-nginx.html" class="invert">How to configure Multiple Domains with Nginx</a></h3></article></div></div></main><footer class="footer"><div class="footer__copyright"><p>jnnn.gs © 2021</p></div><button class="footer__bttop js-footer__bttop" aria-label="Back to top"><svg><title>Back to top</title><use xlink:href="https://jnnn.gs/assets/svg/svg-map.svg#toparrow"/></svg></button></footer></div><script>window.publiiThemeMenuConfig = {    
        mobileMenuMode: 'sidebar',
        animationSpeed: 300,
        submenuWidth: 'auto',
        doubleClickTime: 500,
        mobileMenuExpandableSubmenus: true, 
        relatedContainerForOverlayMenuSelector: '.top',
   };</script><script defer="defer" src="https://jnnn.gs/assets/js/scripts.min.js?v=f4c4d35432d0e17d212f2fae4e0f8247"></script><script>var images = document.querySelectorAll('img[loading]');

        for (var i = 0; i < images.length; i++) {
            if (images[i].complete) {
                images[i].classList.add('is-loaded');
            } else {
                images[i].addEventListener('load', function () {
                    this.classList.add('is-loaded');
                }, false);
            }
        }</script></body></html>